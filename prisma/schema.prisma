generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum BtwTarief {
  HOOG_21
  LAAG_9
  NUL_0
  VRIJGESTELD
  VERLEGD
}

enum InvoiceEmailStatus {
  CONCEPT
  VERZONDEN
  BETAALD
  HERINNERING
}

enum QuotationStatus {
  CONCEPT
  VERZONDEN
  GEACCEPTEERD
  AFGEWEZEN
  OMGEZET
}

enum Eenheid {
  UUR
  STUK
  PROJECT
  LICENTIE
  SERVICE
  KM
  STOP
}

enum UserRole {
  SUPERADMIN
  COMPANY_ADMIN
}

enum SupportMessageStatus {
  NEW
  READ
  CLOSED
}

model User {
  id          String   @id @default(uuid())
  email       String   @unique
  password    String
  naam        String?
  role        UserRole @default(COMPANY_ADMIN)
  isSuspended Boolean  @default(false)

  // Email verification
  emailVerified           Boolean   @default(false)
  emailVerificationToken  String?
  emailVerificationExpiry DateTime?
  emailVerificationSentAt DateTime?

  // Onboarding
  onboardingStep      Int     @default(0)
  onboardingCompleted Boolean @default(false)

  // Two-Factor Authentication
  twoFactorEnabled Boolean @default(false)
  twoFactorSecret  String?
  recoveryCodes    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  companyProfile      CompanyProfile?
  clients             Client[]
  invoices            Invoice[]
  quotations          Quotation[]
  expenses            Expense[]
  timeEntries         TimeEntry[]
  events              Event[]
  verificationTokens  EmailVerificationToken[]
  passwordResetTokens PasswordResetToken[]
  supportMessages     SupportMessage[]
}

model CompanyProfile {
  id              String  @id @default(uuid())
  userId          String  @unique
  companyName     String
  address         String
  postalCode      String
  city            String
  kvkNumber       String
  btwNumber       String
  iban            String
  bankName        String
  paymentTerms    String
  logoUrl         String?
  korEnabled      Boolean @default(false)
  emailSenderName String?
  emailReplyTo    String?
  user            User    @relation(fields: [userId], references: [id])
}

model Client {
  id         String      @id @default(uuid())
  userId     String
  name       String
  address    String
  postalCode String
  city       String
  email      String
  kvkNumber  String?
  btwId      String?
  user       User        @relation(fields: [userId], references: [id])
  invoices   Invoice[]
  quotations Quotation[]
}

model Invoice {
  id                     String             @id @default(uuid())
  userId                 String
  clientId               String
  invoiceNum             String             @unique
  date                   DateTime
  dueDate                DateTime
  emailStatus            InvoiceEmailStatus @default(CONCEPT)
  convertedFromOfferteId String?            @unique
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  user                   User               @relation(fields: [userId], references: [id])
  client                 Client             @relation(fields: [clientId], references: [id])
  convertedFromOfferte   Quotation?         @relation(fields: [convertedFromOfferteId], references: [id])
  lines                  InvoiceLine[]
}

model InvoiceLine {
  id          String    @id @default(uuid())
  invoiceId   String
  description String
  quantity    Decimal   @db.Decimal(10, 2)
  price       Decimal   @db.Decimal(10, 2)
  amount      Decimal   @db.Decimal(12, 2)
  vatRate     BtwTarief
  unit        Eenheid
  invoice     Invoice   @relation(fields: [invoiceId], references: [id])
}

model Quotation {
  id               String          @id @default(uuid())
  userId           String
  clientId         String
  quoteNum         String          @unique
  date             DateTime
  validUntil       DateTime
  status           QuotationStatus @default(CONCEPT)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  user             User            @relation(fields: [userId], references: [id])
  client           Client          @relation(fields: [clientId], references: [id])
  lines            QuotationLine[]
  convertedInvoice Invoice?
}

model QuotationLine {
  id          String    @id @default(uuid())
  quotationId String
  description String
  quantity    Decimal   @db.Decimal(10, 2)
  price       Decimal   @db.Decimal(10, 2)
  amount      Decimal   @db.Decimal(12, 2)
  vatRate     BtwTarief
  unit        Eenheid
  quotation   Quotation @relation(fields: [quotationId], references: [id])
}

model Expense {
  id          String    @id @default(uuid())
  userId      String
  category    String
  description String
  amountExcl  Decimal   @db.Decimal(12, 2)
  vatRate     BtwTarief
  date        DateTime
  receiptUrl  String?
  createdAt   DateTime  @default(now())
  user        User      @relation(fields: [userId], references: [id])
}

model TimeEntry {
  id          String   @id @default(uuid())
  userId      String
  description String
  date        DateTime
  hours       Decimal  @db.Decimal(5, 2)
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id])
}

model Event {
  id          String   @id @default(uuid())
  userId      String
  title       String
  description String?
  start       DateTime
  end         DateTime
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id])
}

model EmailVerificationToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  userId    String
  tokenHash String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@index([userId, expiresAt])
}

model AiActionAuditLog {
  id            String   @id @default(uuid())
  userId        String
  actionType    String
  payloadHash   String
  payloadJson   String?  @db.Text
  requestId     String?
  resultId      String?
  resultType    String?
  entityType    String?
  entityId      String?
  status        String?
  success       Boolean
  errorMessage  String?
  createdAt     DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([actionType])
  @@index([requestId])
}

model SupportMessage {
  id        String               @id @default(uuid())
  userId    String?
  name      String
  email     String
  subject   String
  message   String
  status    SupportMessageStatus @default(NEW)
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([status, createdAt])
}

enum ReleaseCategory {
  BUTTONS
  COLORS
  FUNCTIONS
  MOBILE_COMPATIBILITY
  GENERAL
}

model Release {
  id          String          @id @default(uuid())
  version     String          @unique
  title       String
  description String
  category    ReleaseCategory
  isPublished Boolean         @default(false)
  releaseDate DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
}

model ConversationDraft {
  id              String   @id @default(uuid())
  conversationId  String   @unique
  userId          String
  intent          String
  draftJson       String   @db.Text
  status          String   @default("active")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([conversationId])
  @@index([status])
}
