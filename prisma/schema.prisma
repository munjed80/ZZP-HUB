generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum BtwTarief {
  HOOG_21
  LAAG_9
  NUL_0
  VRIJGESTELD
  VERLEGD
}

enum InvoiceEmailStatus {
  CONCEPT
  VERZONDEN
  BETAALD
  HERINNERING
}

enum QuotationStatus {
  CONCEPT
  VERZONDEN
  GEACCEPTEERD
  AFGEWEZEN
  OMGEZET
}

enum Eenheid {
  UUR
  STUK
  PROJECT
  LICENTIE
  SERVICE
  KM
  STOP
}

enum UserRole {
  SUPERADMIN
  COMPANY_ADMIN
  STAFF
  ACCOUNTANT
}

enum SupportMessageStatus {
  NEW
  READ
  CLOSED
}

model User {
  id          String   @id @default(uuid())
  email       String   @unique
  password    String
  naam        String?
  role        UserRole @default(COMPANY_ADMIN)
  isSuspended Boolean  @default(false)

  // Email verification
  emailVerified           Boolean   @default(false)
  emailVerificationToken  String?
  emailVerificationExpiry DateTime?
  emailVerificationSentAt DateTime?

  // Onboarding
  onboardingStep      Int     @default(0)
  onboardingCompleted Boolean @default(false)

  // Two-Factor Authentication
  twoFactorEnabled Boolean @default(false)
  twoFactorSecret  String?
  recoveryCodes    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  companyProfile      CompanyProfile?
  clients             Client[]
  invoices            Invoice[]
  quotations          Quotation[]
  expenses            Expense[]
  timeEntries         TimeEntry[]
  events              Event[]
  verificationTokens  EmailVerificationToken[]
  passwordResetTokens PasswordResetToken[]
  supportMessages     SupportMessage[]
  invoiceNotes        InvoiceNote[]            @relation("InvoiceNotes")
  expenseNotes        ExpenseNote[]            @relation("ExpenseNotes")
  notifications       Notification[]           @relation("UserNotifications")
  companyAccesses     CompanyUser[]            @relation("CompanyUserCompany")
  linkedCompanies     CompanyUser[]            @relation("CompanyUserUser")
}

model CompanyProfile {
  id              String  @id @default(uuid())
  userId          String  @unique
  companyName     String
  address         String
  postalCode      String
  city            String
  kvkNumber       String
  btwNumber       String
  iban            String
  bankName        String
  paymentTerms    String
  logoUrl         String?
  korEnabled      Boolean @default(false)
  emailSenderName String?
  emailReplyTo    String?
  user            User    @relation(fields: [userId], references: [id])
}

model Client {
  id         String      @id @default(uuid())
  userId     String
  name       String
  address    String
  postalCode String
  city       String
  email      String
  kvkNumber  String?
  btwId      String?
  user       User        @relation(fields: [userId], references: [id])
  invoices   Invoice[]
  quotations Quotation[]

  @@index([userId])
}

model Invoice {
  id                     String             @id @default(uuid())
  userId                 String
  clientId               String
  invoiceNum             String             @unique
  date                   DateTime
  dueDate                DateTime
  emailStatus            InvoiceEmailStatus @default(CONCEPT)
  convertedFromOfferteId String?            @unique
  reviewedAt             DateTime?
  reviewedBy             String?
  reviewStatus           String?            @default("pending") // "pending", "approved", "needs_review"
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  user                   User               @relation(fields: [userId], references: [id])
  client                 Client             @relation(fields: [clientId], references: [id])
  convertedFromOfferte   Quotation?         @relation(fields: [convertedFromOfferteId], references: [id])
  lines                  InvoiceLine[]
  notes                  InvoiceNote[]

  @@index([createdAt])
  @@index([userId, createdAt])
}

model InvoiceLine {
  id          String    @id @default(uuid())
  invoiceId   String
  description String
  quantity    Decimal   @db.Decimal(10, 2)
  price       Decimal   @db.Decimal(10, 2)
  amount      Decimal   @db.Decimal(12, 2)
  vatRate     BtwTarief
  unit        Eenheid
  invoice     Invoice   @relation(fields: [invoiceId], references: [id])
}

model Quotation {
  id               String          @id @default(uuid())
  userId           String
  clientId         String
  quoteNum         String          @unique
  date             DateTime
  validUntil       DateTime
  status           QuotationStatus @default(CONCEPT)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  user             User            @relation(fields: [userId], references: [id])
  client           Client          @relation(fields: [clientId], references: [id])
  lines            QuotationLine[]
  convertedInvoice Invoice?

  @@index([userId])
  @@index([createdAt])
}

model QuotationLine {
  id          String    @id @default(uuid())
  quotationId String
  description String
  quantity    Decimal   @db.Decimal(10, 2)
  price       Decimal   @db.Decimal(10, 2)
  amount      Decimal   @db.Decimal(12, 2)
  vatRate     BtwTarief
  unit        Eenheid
  quotation   Quotation @relation(fields: [quotationId], references: [id])
}

model Expense {
  id            String        @id @default(uuid())
  userId        String
  category      String
  description   String
  amountExcl    Decimal       @db.Decimal(12, 2)
  vatRate       BtwTarief
  date          DateTime
  receiptUrl    String?
  ocrStatus     String? // "pending", "completed", "failed"
  ocrData       String?       @db.Text // JSON: {vendor, amount, date, category}
  extractedData String?       @db.Text // Raw OCR result
  reviewedAt    DateTime?
  reviewedBy    String?
  reviewStatus  String?       @default("pending") // "pending", "approved", "needs_review"
  createdAt     DateTime      @default(now())
  user          User          @relation(fields: [userId], references: [id])
  notes         ExpenseNote[]

  @@index([userId])
  @@index([createdAt])
}

model TimeEntry {
  id          String   @id @default(uuid())
  userId      String
  description String
  date        DateTime
  hours       Decimal  @db.Decimal(5, 2)
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
}

model Event {
  id          String   @id @default(uuid())
  userId      String
  title       String
  description String?
  start       DateTime
  end         DateTime
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
}

model EmailVerificationToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  userId    String
  tokenHash String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@index([userId, expiresAt])
}

model AiActionAuditLog {
  id           String   @id @default(uuid())
  userId       String
  actionType   String
  payloadHash  String
  payloadJson  String?  @db.Text
  requestId    String?
  resultId     String?
  resultType   String?
  entityType   String?
  entityId     String?
  status       String?
  success      Boolean
  errorMessage String?
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([actionType])
  @@index([requestId])
}

model SupportMessage {
  id        String               @id @default(uuid())
  userId    String?
  name      String
  email     String
  subject   String
  message   String
  status    SupportMessageStatus @default(NEW)
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([status, createdAt])
}

enum ReleaseCategory {
  BUTTONS
  COLORS
  FUNCTIONS
  MOBILE_COMPATIBILITY
  GENERAL
}

model Release {
  id          String          @id @default(uuid())
  version     String          @unique
  title       String
  description String
  category    ReleaseCategory
  isPublished Boolean         @default(false)
  releaseDate DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
}

model ConversationDraft {
  id             String   @id @default(uuid())
  conversationId String   @unique
  userId         String
  intent         String
  draftJson      String   @db.Text
  status         String   @default("active")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([userId])
  @@index([conversationId])
  @@index([status])
}

model CompanyUser {
  id           String            @id @default(uuid())
  companyId    String
  userId       String?
  invitedEmail String?
  role         CompanyRole
  status       CompanyUserStatus @default(PENDING)
  tokenHash    String?
  canRead      Boolean           @default(true)
  canEdit      Boolean           @default(false)
  canExport    Boolean           @default(false)
  canBTW       Boolean           @default(false)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  company User  @relation("CompanyUserCompany", fields: [companyId], references: [id], onDelete: Cascade)
  user    User? @relation("CompanyUserUser", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([companyId, userId])
  @@unique([tokenHash])
  @@index([companyId])
  @@index([userId])
  @@index([invitedEmail])
}

enum CompanyRole {
  OWNER
  ACCOUNTANT
}

enum CompanyUserStatus {
  PENDING
  ACTIVE
  REVOKED
  EXPIRED
}

model InvoiceNote {
  id        String   @id @default(uuid())
  invoiceId String
  userId    String
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  user    User    @relation("InvoiceNotes", fields: [userId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([userId])
  @@index([createdAt])
}

model ExpenseNote {
  id        String   @id @default(uuid())
  expenseId String
  userId    String
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  expense Expense @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  user    User    @relation("ExpenseNotes", fields: [userId], references: [id], onDelete: Cascade)

  @@index([expenseId])
  @@index([userId])
  @@index([createdAt])
}

model Notification {
  id         String   @id @default(uuid())
  userId     String
  type       String // "invoice_review", "expense_flagged", "invoice_due", etc.
  title      String
  message    String
  entityType String? // "invoice", "expense", "event"
  entityId   String?
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())

  user User @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@index([userId, isRead, createdAt])
}
